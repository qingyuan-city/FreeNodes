name: ğŸ”„ åŒæ­¥FreeNodesé¡¹ç›®å¹¶æ¨é€ç‰¹å®šæ–‡ä»¶åˆ°teamä»“åº“

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # ---------- åŒæ­¥ä¸Šæ¸¸ FreeNodes ----------
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # è·å–å®Œæ•´å†å²ï¼Œä¾¿äºåç»­æ“ä½œ

      - name: é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: æ·»åŠ ä¸Šæ¸¸ä»“åº“å¹¶è·å–æ›´æ–°
        run: |
          # å¦‚æœä¹‹å‰å­˜åœ¨ upstream remoteï¼Œå…ˆç§»é™¤ï¼ˆæ–°ç¯å¢ƒé€šå¸¸æ²¡æœ‰ï¼Œä½†å®‰å…¨å¤„ç†ï¼‰
          git remote remove upstream 2>/dev/null || true
          git remote add upstream https://github.com/shuaidaoya/FreeNodes.git
          git fetch upstream

      - name: ç”¨ä¸Šæ¸¸æ–‡ä»¶è¦†ç›–æ‰€æœ‰åŒåæ–‡ä»¶ï¼ˆä¿ç•™æœ¬åœ°æ–°å¢æ–‡ä»¶ï¼‰
        run: |
          git checkout main
          # å°†ä¸Šæ¸¸æ‰€æœ‰æ–‡ä»¶æ£€å‡ºåˆ°å·¥ä½œåŒºï¼ˆè¦†ç›–æœ¬åœ°å·²æœ‰æ–‡ä»¶ï¼Œä½†ä¸åˆ é™¤æœ¬åœ°ç‹¬æœ‰çš„æ–‡ä»¶ï¼‰
          git checkout upstream/main -- .
          # å°†æ‰€æœ‰å˜æ›´ï¼ˆåŒ…æ‹¬ä¸Šæ¸¸æ–‡ä»¶å’Œæœ¬åœ°æ–°å¢æ–‡ä»¶ï¼‰æ·»åŠ åˆ°æš‚å­˜åŒº
          git add .
          # æäº¤åˆå¹¶ç»“æœï¼ˆå¦‚æœæ²¡æœ‰å˜æ›´ï¼Œgit commit ä¼šå¤±è´¥ï¼Œæ‰€ä»¥ç”¨æ¡ä»¶åˆ¤æ–­ï¼‰
          git diff --staged --quiet || git commit -m "chore: åŒæ­¥ä¸Šæ¸¸æ›´æ–°ï¼Œä¿ç•™æœ¬åœ°æ–°å¢æ–‡ä»¶"

      - name: æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“
        run: git push origin main

      # ---------- æ¨é€æŒ‡å®šæ–‡ä»¶åˆ° team ä»“åº“ ----------
      - name: æ£€å‡ºç›®æ ‡ä»“åº“ (team)
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/team
          token: ${{ secrets.QINGYUAN_PAT }}   # éœ€æå‰åœ¨ä»“åº“ Secrets ä¸­è®¾ç½®
          path: target

      - name: å¤åˆ¶æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“
        run: |
          cp nodes/all.yaml target/ || echo "all.yaml not found, skipping"
          cp nodes/base64.txt target/ || echo "base64.txt not found, skipping"
          cp nodes/base64.txt target/auto.txt || echo "base64.txt not found, skipping (auto)"
          cp nodes/history.yaml target/ || echo "history.yaml not found, skipping"
          cp nodes/mihomo.yaml target/ || echo "mihomo.yaml not found, skipping"

      - name: æäº¤å¹¶æ¨é€åˆ° team ä»“åº“
        run: |
          cd target
          # æ³¨æ„ï¼šå…¨å±€é…ç½®å·²ç»ç”Ÿæ•ˆï¼Œæ­¤å¤„æ— éœ€é‡å¤é…ç½®ï¼Œä½†ä¿ç•™ä¹Ÿæ— å¦¨
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Sync files from ${{ github.repository }}"
            git push
          fi
